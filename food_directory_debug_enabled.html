<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Food Directory (Debug Enabled)</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    table.dataTable thead th { background: #333; color: #fff; }
    #loading { font-size: 1.2em; margin-bottom: 1em; }
    #error { color: red; margin-top: 1em; display: none; }
    #debug { background: #f3f3f3; font-family: monospace; padding: 1em; margin-top: 2em; border-left: 5px solid #777; white-space: pre-wrap; display: none; }
  </style>
</head>
<body>

  <h1>Food Directory (Debug Enabled)</h1>
  <div id="loading">Loading data from Google Sheets...</div>
  <table id="foodTable" class="display" style="width:100%">
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>County</th>
        <th>City</th>
        <th>Location</th>
        <th>Contact Info</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="error">⚠️ Failed to load data. See debug info below.</div>
  <div id="debug"></div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript">
    function logDebug(message) {
      const debugBox = document.getElementById("debug");
      debugBox.style.display = "block";
      debugBox.textContent += message + "\n";
    }

    function init() {
      const sheetID = "1Ka38m6-YSpN8FM950bpAOuGclECx8qyqZdAKRcA7QdM";
      const sheetName = "Sheet1";
      const query = encodeURIComponent("SELECT A, B, C, D, E, F");
      const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName}&tq=${query}`;

      logDebug("Fetching: " + url);

      fetch(url)
        .then(res => {
          logDebug("Response status: " + res.status);
          return res.text();
        })
        .then(rep => {
          logDebug("Raw response length: " + rep.length);
          const json = JSON.parse(rep.substr(47).slice(0, -2));
          const data = json.table.rows.map(row => row.c.map(cell => cell ? cell.v : ""));
          const tableBody = document.querySelector("#foodTable tbody");

          data.forEach(row => {
            const tr = document.createElement("tr");
            row.forEach(cell => {
              const td = document.createElement("td");
              td.textContent = cell;
              tr.appendChild(td);
            });
            tableBody.appendChild(tr);
          });

          $('#loading').hide();
          $('#foodTable').DataTable({ pageLength: 25 });
          logDebug("✅ DataTable loaded successfully.");
        })
        .catch(err => {
          console.error("Error loading sheet:", err);
          $('#loading').hide();
          $('#error').show();
          logDebug("❌ Error: " + err.message);
        });
    }

    window.onload = init;
  </script>
</body>
</html>